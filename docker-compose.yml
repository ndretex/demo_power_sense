services:
  # ----------- Storage (ClickHouse) -----------
  clickhouse:
    image: clickhouse/clickhouse-server:latest
    container_name: dps_clickhouse
    environment:
      CLICKHOUSE_DB: electricity
      CLICKHOUSE_USER: electricity
      CLICKHOUSE_PASSWORD: electricity
    ports:
      - "${DPS_CLICKHOUSE_HOST_PORT}:${DPS_CLICKHOUSE_CONTAINER_PORT}"
    volumes:
      - chdata:/var/lib/clickhouse
      - ./ch/init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:${DPS_CLICKHOUSE_CONTAINER_PORT}/ping | grep -q Ok"]
      interval: 10s
      timeout: 5s
      retries: 10

  # ----------- dbt (derived models) -----------
  dbt:
    build:
      context: ./dbt
      dockerfile: Dockerfile
    container_name: dps_dbt
    environment:
      DB_HOST: clickhouse
      DB_PORT: "${DPS_CLICKHOUSE_CONTAINER_PORT}"
      DB_NAME: electricity
      DB_USER: electricity
      DB_PASSWORD: electricity
    command: ["build"]
    depends_on:
      clickhouse:
        condition: service_healthy
    restart: "no"

  # ----------- Prefect worker (runs project flows) -----------
  prefect_worker:
    build:
      context: ./services/prefect_worker
      dockerfile: Dockerfile
    container_name: dps_prefect_worker
    environment:
      # DB
      DB_HOST: clickhouse
      DB_PORT: "${DPS_CLICKHOUSE_CONTAINER_PORT}"
      DB_NAME: electricity
      DB_USER: electricity
      DB_PASSWORD: electricity

      # Data API
      DATA_API_URL: http://api_data:${DPS_API_CONTAINER_PORT}

      # Ingestion config
      INGEST_INTERVAL_SECONDS: "60" # every 1 minute

      # Prefect
      PREFECT_API_URL: http://prefect:${DPS_PREFECT_API_PORT}/api # if this is not explicitly set and if left to depend on .env, it will try to reach Prefect on websocket port 4200 instead of http
      PREFECT_LOGGING_EXTRA_LOGGERS: loguru
      PREFECT_LOCAL_STORAGE_PATH: /task-storage # <---- mandatory when using .delay for background tasks
      REQUEST_TIMEOUT: 60

      # Example: if you use an external API token
      # API_TOKEN: "${API_TOKEN}"
      LOG_LEVEL: "INFO"
    entrypoint: /bin/sh -c "./init.sh"
    depends_on:
      clickhouse:
        condition: service_healthy
      api_data:
        condition: service_started
    restart: unless-stopped
    labels:
      logging: promtail
    networks:
      default:
        aliases:
          - ingest
      microservices-network: {}

  # ----------- Data API (FastAPI) -----------
  api_data:
    build:
      context: ./services/api_data
      dockerfile: Dockerfile
    container_name: dps_api_data
    environment:
      DB_HOST: clickhouse
      DB_PORT: "${DPS_CLICKHOUSE_CONTAINER_PORT}"
      DB_NAME: electricity
      DB_USER: electricity
      DB_PASSWORD: electricity
      LOG_LEVEL: "INFO"
    ports:
      - "${DPS_API_HOST_PORT}:${DPS_API_CONTAINER_PORT}"
    depends_on:
      clickhouse:
        condition: service_healthy
      dbt:
        condition: service_completed_successfully
    restart: unless-stopped
    labels:
      logging: promtail
    networks:
      default:
        aliases:
          - api_data
      microservices-network: {}

  # ----------- Metrics: Prometheus -----------
  prometheus:
    image: prom/prometheus:latest
    container_name: dps_prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
    ports:
      - "${DPS_PROMETHEUS_HOST_PORT}:${DPS_PROMETHEUS_CONTAINER_PORT}"
    volumes:
      - ./observability/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - promdata:/prometheus
    depends_on:
      - prefect_worker

  # ----------- Logs: Loki -----------
  loki:
    image: grafana/loki:2.9.8
    container_name: dps_loki
    command: ["-config.file=/etc/loki/config.yml"]
    ports:
      - "${DPS_LOKI_HOST_PORT}:${DPS_LOKI_CONTAINER_PORT}"
    volumes:
      - ./observability/loki/config.yml:/etc/loki/config.yml:ro
      - lokidata:/loki

  # ----------- Logs shipper: Promtail (reads docker logs) -----------
  promtail:
    image: grafana/promtail:latest
    container_name: dps_promtail
    command: ["-config.file=/etc/promtail/config.yml"]
    volumes:
      - ./observability/promtail/config.yml:/etc/promtail/config.yml:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    depends_on:
      - loki

  # ----------- Grafana (dashboards + “show data”) -----------
  grafana:
    image: grafana/grafana:latest
    container_name: dps_grafana
    ports:
      - "${DPS_GRAFANA_HOST_PORT}:${DPS_GRAFANA_CONTAINER_PORT}"
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_INSTALL_PLUGINS: grafana-clickhouse-datasource
    volumes:
      - grafanadata:/var/lib/grafana
      - ./observability/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./observability/grafana/dashboards:/var/lib/grafana/dashboards:ro
    depends_on:
      - prometheus
      - clickhouse
      - loki

volumes:
  chdata:
  promdata:
  lokidata:
  grafanadata:

networks:
  microservices-network:
    external: true
